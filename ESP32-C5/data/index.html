<!doctype html>
<html>
    <head>
        <meta charset='utf-8'>
        <title>HandTool</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <style>body{font-family:Arial,Helvetica,sans-serif;margin:12px;}img{border:1px solid #ddd;padding:4px;background:#fff}</style>
    </head>
    <body>
        <h1>HandTool Web Server</h1>
        <p><img src="https://raw.githubusercontent.com/vgroenhuis/HandTool/refs/heads/main/pics/HandTool_500px.jpg" alt="HandTool" style="max-width:100%;height:auto;"></p>
        <h2>Battery</h2>
        <ul>
            <li>Voltage: <span id="batteryVoltage">$BATTERY_VOLTAGE$</span> V</li>
        </ul>
        <h2>Robot View (3D)</h2>
        <ul>
            <li><a href="/robotView.html">/robotView.html</a> Open Robot View (3D)</li>
        </ul>
        <h2>WiFi mananger</h2>
        <ul>
            <li><a href="/wifi">/wifi</a> Open WiFi Manager</li>
        </ul>
        <h2>External links</h2>
        <ul>
            <li><a href="https://github.com/vgroenhuis/HandTool" target="_blank">github.com/vgroenhuis/HandTool</a> Github repository with CAD files, sources, manual and assembly instructions</li>
        </ul>
        <h2>HTTP endpoints on this device:</h2>
        <ul>
            <li><a href="/">/</a> This page.</li>
            <li><a href="/index.html">/index.html</a> This page.</li>
            <li><a href="/robotView.html">/robotView.html</a> Open Robot View (3D)</li>
            <li><a href="/wifi">/wifi</a> Open WiFi Manager</li>
            <li><a href="/allData">/allData</a> JSON structure with all available data</li>
            <li><a href="/angles">/angles</a> JSON structure with joint angles in degrees</li>
            <li><a href="/rawAdcValues">/rawAdcValues</a> JSON structure with raw ADC values</li>
            <li><a href="/fk">/fk</a> JSON structure with end-effector to robot coordinate transformation matrix</li>
            <li><a href="/dhParams">/dhParams</a> JSON structure with Denavit-Hartenberg parameters</li>
            <li><a href="/serialAngles?enable=1">/serialAngles?enable=1</a> Enable serial output of joint angles</li>
            <li><a href="/serialFK?enable=1">/serialFK?enable=1</a> Enable serial output of end-effector coordinate transformation data</li>
            <li><a href="/serialFrequency?hz=10">/serialFrequency?hz=10</a> Set serial output frequency to 10 Hz</li>
        </ul>
        <h2>Serial Output</h2>
        <p>
            <label>
                <input type="checkbox" id="serialAnglesToggle">
                Output joint angles to serial port
            </label>
        </p>
        <p>
            <label>
                <input type="checkbox" id="serialFKToggle">
                Output FK transformation matrix to serial port
            </label>
        </p>
        <p>
            <label>
                Frequency (Hz): 
                <input type="number" id="serialFrequencyInput" min="0.1" max="1000" step="0.1" value="10" style="width:80px;">
                <button id="setFrequencyBtn">Set</button>
            </label>
            <span id="frequencyStatus" style="margin-left:10px;color:#666;"></span>
        </p>
        <h2>Data Display</h2>
        <p>
            <label>
                <input type="checkbox" id="autoUpdateToggle">
                Auto-update data
            </label>
        </p>
        <h3>Joint angles (degrees)</h3>
        <div id="angles_deg">Enable auto-update data first</div>
        <h3>Analog inputs (raw)</h3>
        <div id="adc_raw">Enable auto-update data first</div>
        <h3>Analog inputs (filtered)</h3>
        <div id="adc_filtered">Enable auto-update data first</div>

        <script>
            let fetchInterval = 50; // desired interval in ms
            let isRunning = true;

            // Toggle auto-update on checkbox change
            document.addEventListener('DOMContentLoaded', function() {
                const toggle = document.getElementById('autoUpdateToggle');
                toggle.addEventListener('change', function() {
                    isRunning = this.checked;
                    if (isRunning) {
                        pollData(); // Restart polling if it was stopped
                    }
                });

                // Toggle serial output of joint angles
                const serialAnglesToggle = document.getElementById('serialAnglesToggle');
                serialAnglesToggle.addEventListener('change', function() {
                    fetch('/serialAngles?enable=' + (this.checked ? '1' : '0'))
                        .then(r => r.text())
                        .then(msg => console.log(msg))
                        .catch(e => console.error('Serial angles toggle error:', e));
                });

                // Toggle serial output of FK data
                const serialFKToggle = document.getElementById('serialFKToggle');
                serialFKToggle.addEventListener('change', function() {
                    fetch('/serialFK?enable=' + (this.checked ? '1' : '0'))
                        .then(r => r.text())
                        .then(msg => console.log(msg))
                        .catch(e => console.error('Serial FK toggle error:', e));
                });

                // Set serial output frequency
                const setFrequencyBtn = document.getElementById('setFrequencyBtn');
                const frequencyInput = document.getElementById('serialFrequencyInput');
                const frequencyStatus = document.getElementById('frequencyStatus');
                
                setFrequencyBtn.addEventListener('click', function() {
                    const hz = parseFloat(frequencyInput.value);
                    if (hz > 0 && hz <= 1000) {
                        fetch('/serialFrequency?hz=' + hz)
                            .then(r => r.text())
                            .then(msg => {
                                console.log(msg);
                                frequencyStatus.textContent = '✓ ' + msg;
                                frequencyStatus.style.color = '#080';
                                setTimeout(() => frequencyStatus.textContent = '', 3000);
                            })
                            .catch(e => {
                                console.error('Frequency set error:', e);
                                frequencyStatus.textContent = '✗ Error';
                                frequencyStatus.style.color = '#d00';
                            });
                    } else {
                        frequencyStatus.textContent = '✗ Invalid frequency';
                        frequencyStatus.style.color = '#d00';
                    }
                });

                // Load current frequency on page load
                fetch('/serialFrequency')
                    .then(r => r.text())
                    .then(msg => console.log('Current serial output: ' + msg))
                    .catch(e => console.error('Frequency query error:', e));
            });

            async function fetchAllData(){
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 200);
                    const r = await fetch('/allData', { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if(!r.ok) return;
                    const j = await r.json();

                    // joint angles
                    const elAngles = document.getElementById('angles_deg');
                    const elAdcRaw = document.getElementById('adc_raw');
                    const elAdcFiltered = document.getElementById('adc_filtered');
                    if (j.valid === false) {
                        elAngles.innerHTML = '<p style="color:#d00;font-weight:bold;">⚠️ MCP3008 not detected - Joint angles unavailable</p>';
                        elAdcRaw.innerHTML = '<p style="color:#d00;font-weight:bold;">⚠️ MCP3008 not detected - Raw ADC data unavailable</p>';
                        elAdcFiltered.innerHTML = '<p style="color:#d00;font-weight:bold;">⚠️ MCP3008 not detected - Filtered ADC data unavailable</p>';
                    } else {
                        let htmlAngles = '<ul>';
                        for(let i=0;i<6;i++) htmlAngles += `<li>J${i+1}: ${j.jointAngles[i]}</li>`;
                        htmlAngles += '</ul>';
                        elAngles.innerHTML = htmlAngles;

                        let htmlRaw = '<ul>';
                        for(let i=0;i<8;i++) htmlRaw += `<li>CH${i}: ${j.rawAdcValues[i]}</li>`;
                        htmlRaw += '</ul>';
                        elAdcRaw.innerHTML = htmlRaw;

                        let htmlFiltered = '<ul>';
                        for(let i=0;i<8;i++) htmlFiltered += `<li>CH${i}: ${j.filteredAdcValues[i]}</li>`;
                        htmlFiltered += '</ul>';
                        elAdcFiltered.innerHTML = htmlFiltered;
                    }
                } catch(e) {
                    console.error('Fetch error:', e);
                }
            }

            // Synchronous polling loop: wait for response before next request
            async function pollData() {
                while(isRunning) {
                    const start = Date.now();
                    await fetchAllData();
                    const elapsed = Date.now() - start;
                    // Wait for remaining interval time, or briefly if request took longer
                    const waitTime = Math.max(0, fetchInterval - elapsed);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
            //pollData();
        </script>
    </body>
</html>
